name: Query Engine
on:
  push:

jobs:

  test:
    name: "Test Query Engine - ${{ matrix.connector }}"
    
    strategy:
      fail-fast: false
      matrix:
        connector: [sqlite, postgresql9, postgresql10, postgresql11, postgresql12, postgresql13, pgbouncer, mysql, mysql56, mysql8, mariadb, mssql2017, mssql2019]
        
    container:
      image: prismagraphql/build:test
        
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - run: sudo curl -L "https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      - run: sudo chmod +x /usr/local/bin/docker-compose
      - run: docker-compose --version

      - name: "Start databases"
        run: docker-compose up -d --file docker-compose.qe-tests.yml
        
      - run: rustup default stable
      - run: sbt test
        working-directory: query-engine/connector-test-kit
        env:
          SERVER_ROOT: /__w/prisma-engines/prisma-engines
          TEST_CONNECTOR: ${{ matrix.connector }}
          TEST_MODE: simple
